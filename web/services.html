<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واجهة خدمات ماركت حلب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
        }

        :root {
            --color-dark-green: #064E3B;
            --color-light-green: #ECFDF5;
        }

        .bg-dark-green { background-color: var(--color-dark-green); }
        .text-dark-green { color: var(--color-dark-green); }

        .category-card {
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 12rem;
        }
        .category-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(6, 78, 59, 0.7), transparent);
            border-radius: 1rem;
            z-index: 1;
        }
        .category-card-content {
            position: relative;
            z-index: 2;
            padding: 1rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .category-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .category-scroll::-webkit-scrollbar {
            display: none;
        }
        #loader {
            border: 5px solid #E5E7EB;
            border-top: 5px solid var(--color-dark-green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -25px;
            margin-top: -25px;
            z-index: 50;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (min-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        .quantity-input {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .quantity-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .quantity-btn:hover {
            background-color: #e0e0e0;
        }
        .service-details-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .quantity-option-btn {
            transition: all 0.3s ease;
        }
        .quantity-option-btn.selected {
            background-color: var(--color-dark-green);
            color: white;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        .breadcrumb-item {
            display: flex;
            align-items: center;
        }
        .breadcrumb-item:not(:last-child)::after {
            content: "/";
            margin: 0 0.5rem;
            color: #6b7280;
        }
        .breadcrumb-link {
            color: var(--color-dark-green);
            cursor: pointer;
        }
        .breadcrumb-link:hover {
            text-decoration: underline;
        }
        .breadcrumb-current {
            color: #6b7280;
        }
        
        .quantity-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .quantity-option {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quantity-option:hover {
            border-color: #064E3B;
        }
        .quantity-option.selected {
            background-color: #064E3B;
            color: white;
            border-color: #064E3B;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-copy-btn {
            background-color: #064E3B;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            cursor: pointer;
            text-align: center;
        }
        .modal-log-area {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: monospace;
            overflow-x: auto;
            max-height: 40vh;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader"></div>

    <div id="app-content" class="min-h-screen flex flex-col bg-white shadow-lg rounded-2xl hidden">

        <header class="p-5">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <h1 class="text-3xl font-bold text-dark-green tracking-wide">
                        <span class="flex items-center">
                            <span class="ml-2">ماركت حلب</span>
                            <svg class="w-6 h-6 fill-current text-dark-green" viewBox="0 0 24 24">
                                <path d="M12 2L6 5V9H18V5L12 2ZM6 11V22H18V11H6ZM10 13H14V15H10V13ZM10 17H14V19H10V17Z"/>
                            </svg>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="relative">
                <input type="text" placeholder="ابحث عن منتج أو خدمة..." class="w-full pr-12 pl-4 py-3 rounded-full bg-gray-200 text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-dark-green transition duration-300">
                <svg class="absolute right-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <div id="user-info" class="flex items-center justify-between mt-4">
                <p id="user-fullname" class="text-sm font-semibold text-gray-700">معرف المستخدم: <span id="user-id-display">...</span></p>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span id="user-balance" class="text-lg font-bold text-dark-green">$0.00</span>
                    <svg class="w-5 h-5 text-yellow-500 fill-current" viewBox="0 0 24 24">
                        <path d="M18 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H6V4h12v16zM15 13H9c-.55 0-1-.45-1-1s.45-1 1-1h6c.55 0 1 .45 1 1s-.45 1-1 1zm-3-3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zM15 15H9c-.55 0-1-.45-1-1s.45-1 1-1h6c.55 0 1 .45 1 1s-.45 1-1 1z"/>
                    </svg>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 pb-20">
            <div id="main-categories-section">
                <h2 class="text-xl font-bold text-dark-green mb-4">التصنيفات الرئيسية</h2>
                <div id="main-categories" class="grid grid-cols-2 gap-4"></div>
            </div>
            
            <div id="sub-categories-section" class="hidden">
                <button id="back-to-home" class="mb-4 flex items-center text-dark-green font-semibold">
                    <svg class="w-5 h-5 ml-2 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    العودة
                </button>
                
                <div id="breadcrumb" class="breadcrumb mb-4"></div>
                
                <h2 id="subcategories-title" class="text-xl font-bold mb-4 text-dark-green"></h2>
                <div id="sub-categories" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>
            
            <div id="services-section" class="hidden">
                <button id="back-to-subcategories" class="mb-4 flex items-center text-dark-green font-semibold">
                    <svg class="w-5 h-5 ml-2 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    العودة
                </button>
                
                <div id="breadcrumb-services" class="breadcrumb mb-4"></div>
                
                <h2 id="products-title" class="text-xl font-bold mb-4 text-dark-green"></h2>
                <div id="services" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            
            <div id="service-details-section" class="hidden">
                <button id="back-to-services" class="mb-4 flex items-center text-dark-green font-semibold">
                    <svg class="w-5 h-5 ml-2 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    العودة
                </button>
                
                <div id="breadcrumb-details" class="breadcrumb mb-4"></div>
                
                <div id="service-details" class="bg-white rounded-xl shadow-lg p-4">
                </div>
            </div>
        </main>

        <div class="fixed bottom-0 left-0 w-full bg-dark-green rounded-t-3xl shadow-lg p-4 z-50">
            <nav class="flex justify-around items-center text-white">
                <a href="./pyments.html" class="flex flex-col items-center text-center text-light-green hover:text-white transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" x2="23" y2="10"></line>
                        <path d="M12 14h.01"></path>
                        <path d="M16 14h.01"></path>
                        <path d="M8 14h.01"></path>
                    </svg>
                    <span class="text-sm">إضافة رصيد</span>
                </a>
                <a href="./services.html" class="flex flex-col items-center text-center text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span class="text-sm">الخدمات</span>
                </a>
                <a href="./wallet.html" class="flex flex-col items-center text-center text-light-green hover:text-white transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 2a2 2 0 00-2 2v2H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-9a2 2 0 00-2-2h-3V4a2 2 0 00-2-2h-4zM8 4a1 1 0 011-1h6a1 1 0 011 1v2H8V4zm11 8H5v-2h14v2z" />
                    </svg>
                    <span class="text-sm">محفظتي</span>
                </a>
                <a href="./orders.html" class="flex flex-col items-center text-center text-light-green hover:text-white transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-2 4l-2-2m0 0l-2 2m2-2v7m-4 1h8a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm">طلباتي</span>
                </a>
            </nav>
        </div>
    </div>

    <div id="error-modal" class="modal hidden">
        <div class="modal-content">
            <button id="close-modal-btn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-bold text-dark-green">سجل الأخطاء</h3>
            <p class="text-sm text-gray-500 mt-1">يُرجى نسخ السجل وإرساله إلى الدعم الفني للمساعدة.</p>
            <textarea id="error-log-area" class="modal-log-area w-full mt-4" readonly></textarea>
            <div class="flex justify-center">
                <button id="copy-log-btn" class="modal-copy-btn">نسخ السجل</button>
            </div>
        </div>
    </div>

    <script>
    const SUPABASE_URL = 'https://vgknohxqkkuxhtnqxzfb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZna25vaHhxa2t1eGh0bnF4emZiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NzA2ODgxMSwiZXhwIjoyMDcyNjQ0ODExfQ.nVhvJtXR3_g611P0wkHwbHDeUyIWHjA5aiba9u5aQ9Q';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const gData = {
        user: null,
        orders: [],
        categories: [],
        services: [],
        initData: null,
        breadcrumb: []
    };

    const lazyImageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const element = entry.target;
                const bgImage = element.dataset.bgSrc;
                if (bgImage) {
                    element.style.backgroundImage = `url('${bgImage}')`;
                }
                observer.unobserve(element);
            }
        });
    });
    
    const logs = [];

    function logError(message, error, showModal = true) {
        const timestamp = new Date().toISOString();
        const logEntry = { timestamp, message, error: error?.message || 'N/A' };
        logs.push(logEntry);
        console.error(message, error);
        const logArea = document.getElementById('error-log-area');
        if (logArea) {
             logArea.value = logs.map(l => 
                `[${l.timestamp}] ${l.message} - Error: ${l.error}`
            ).join('\n');
        }
        if (showModal) {
             showErrorModal(message);
        }
    }

    // دالة جديدة للتحقق من نوع القيم في qty_values
    function determineQtyValuesType(qtyValues) {
        if (!qtyValues || qtyValues.length === 0) return 'unknown';
        
        // إذا كانت جميع القيم أرقامًا
        const allNumbers = qtyValues.every(item => {
            const num = parseFloat(item);
            return !isNaN(num) && isFinite(item);
        });
        
        if (allNumbers) return 'numbers';
        
        // إذا كانت جميع القيم نصوصًا
        const allStrings = qtyValues.every(item => typeof item === 'string');
        if (allStrings) return 'strings';
        
        return 'mixed';
    }

    const loader = document.getElementById('loader');
    const appContent = document.getElementById('app-content');
    const mainCategoriesSection = document.getElementById('main-categories-section');
    const userBalanceEl = document.getElementById('user-balance');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const mainCategoriesContainer = document.getElementById('main-categories');
    const subCategoriesSection = document.getElementById('sub-categories-section');
    const subCategoriesTitle = document.getElementById('subcategories-title');
    const subCategoriesContainer = document.getElementById('sub-categories');
    const servicesSection = document.getElementById('services-section');
    const servicesTitle = document.getElementById('products-title');
    const servicesContainer = document.getElementById('services');
    const backToHomeBtn = document.getElementById('back-to-home');
    const backToSubcategoriesBtn = document.getElementById('back-to-subcategories');
    
    const serviceDetailsSection = document.getElementById('service-details-section');
    const serviceDetailsContainer = document.getElementById('service-details');
    const backToServicesBtn = document.getElementById('back-to-services');
    
    const breadcrumbContainer = document.getElementById('breadcrumb');
    const breadcrumbServicesContainer = document.getElementById('breadcrumb-services');
    const breadcrumbDetailsContainer = document.getElementById('breadcrumb-details');
    
    const errorModal = document.getElementById('error-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const copyLogBtn = document.getElementById('copy-log-btn');

    let currentParentId = null;
    let currentService = null;

    document.addEventListener('DOMContentLoaded', () => {
        try {
            const tg = window.Telegram.WebApp;
            tg.ready();
            gData.initData = tg.initData;
            fetchInitialData(tg.initData);
        } catch (error) {
            logError('Telegram WebApp is not available.', error);
            fetchInitialData('local_test_data');
        }
    });

    async function fetchInitialData(initData) {
        try {
            const localResponse = await fetch('/api/webapp/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: initData }),
            });
            if (!localResponse.ok) throw new Error(`Local API error! status: ${localResponse.status}`);
            const localData = await localResponse.json();
            if (!localData.ok) throw new Error(localData.error || 'Failed to fetch local data.');

            gData.user = localData.user;
            gData.orders = localData.orders;

            const { data: categories, error: categoriesError } = await supabase
                .from('categories')
                .select('*')
                .order('id');
            if (categoriesError) throw categoriesError;

            const { data: services, error: servicesError } = await supabase
                .from('services')
                .select('*')
                .order('id');
            if (servicesError) throw servicesError;

            gData.categories = categories || [];
            gData.services = services || [];

            renderApp();

        } catch (error) {
            logError('Error fetching initial data:', error);
            mainCategoriesSection.innerHTML = `<p class="text-center text-red-500">حدث خطأ أثناء تحميل البيانات. يرجى إعادة تحميل الصفحة.</p>`;
        } finally {
            loader.style.display = 'none';
            appContent.classList.remove('hidden');
            appContent.classList.add('flex');
        }
    }

    function getSubCategoryImage(categoryId) {
        const service = gData.services.find(s => s.category_id === categoryId && s.category_img);
        if (service && service.category_img) {
            return service.category_img;
        }
        const category = gData.categories.find(c => c.id === categoryId);
        return `https://placehold.co/600x400/064e3b/ecfdf5?text=${encodeURIComponent(category?.name || 'تصنيف')}`;
    }

    function generateBreadcrumb(categoryId, container) {
        if (!container) return;
        container.innerHTML = '';
        const homeItem = document.createElement('div');
        homeItem.className = 'breadcrumb-item';
        homeItem.innerHTML = `<span class="breadcrumb-link" data-category-id="home">الرئيسية</span>`;
        container.appendChild(homeItem);

        if (categoryId) {
            const path = getCategoryPath(categoryId);
            path.forEach((cat, index) => {
                const item = document.createElement('div');
                item.className = 'breadcrumb-item';
                if (index === path.length - 1) {
                    item.innerHTML = `<span class="breadcrumb-current">${cat.name}</span>`;
                } else {
                    item.innerHTML = `<span class="breadcrumb-link" data-category-id="${cat.id}">${cat.name}</span>`;
                }
                container.appendChild(item);
            });
        }
        
        const breadcrumbLinks = container.querySelectorAll('.breadcrumb-link');
        breadcrumbLinks.forEach(link => {
            link.addEventListener('click', () => {
                const catId = link.getAttribute('data-category-id');
                if (catId === 'home') {
                    renderMainCategories();
                } else {
                    renderSubCategories(parseInt(catId, 10));
                }
            });
        });
    }

    function getCategoryPath(categoryId) {
        const path = [];
        let currentId = categoryId;
        while (currentId) {
            const category = gData.categories.find(c => c.id === currentId);
            if (category) {
                path.unshift(category);
                currentId = category.parent_id;
            } else {
                break;
            }
        }
        return path;
    }

    function renderApp() {
        renderUserInfo();
        renderMainCategories();
    }

    function renderUserInfo() {
        if (gData.user) {
            userBalanceEl.textContent = `$${gData.user.balance || '0.00'}`;
            userIdDisplayEl.textContent = gData.user.id;
        }
    }

    function renderMainCategories() {
        mainCategoriesContainer.innerHTML = '';
        subCategoriesSection.classList.add('hidden');
        servicesSection.classList.add('hidden');
        serviceDetailsSection.classList.add('hidden');
        mainCategoriesSection.classList.remove('hidden');
        
        gData.breadcrumb = [];
        
        const mainCategories = gData.categories.filter(c => c.parent_id === null);
        mainCategories.forEach(cat => {
            const catElement = document.createElement('a');
            catElement.href = '#';
            catElement.className = 'category-card rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 fade-in';
            const bgImage = cat.category_img || `https://placehold.co/600x400/064e3b/ecfdf5?text=${encodeURIComponent(cat.name)}`;
            catElement.dataset.bgSrc = bgImage;
            catElement.dataset.categoryId = cat.id;
            catElement.innerHTML = `
                <div class="category-card-overlay rounded-2xl"></div>
                <div class="category-card-content">
                    <h3 class="text-xl font-bold">${cat.name}</h3>
                </div>
            `;
            mainCategoriesContainer.appendChild(catElement);
            lazyImageObserver.observe(catElement);
        });
    }

    function renderSubCategories(parentId) {
        currentParentId = parentId;
        subCategoriesContainer.innerHTML = '';
        
        const parentCategory = gData.categories.find(c => c.id === parentId);
        subCategoriesTitle.textContent = parentCategory?.name || 'التصنيفات الفرعية';
        
        generateBreadcrumb(parentId, breadcrumbContainer);
        
        const subCategories = gData.categories.filter(c => c.parent_id === parentId);

        if (subCategories.length > 0) {
            // If there are subcategories, display them along with any services in the unified view.
            const services = gData.services.filter(s => s.category_id === parentId);
            const combinedItems = [
                ...subCategories.map(c => ({...c, item_type: 'category'})),
                ...services.map(s => ({...s, item_type: 'service'}))
            ];

            combinedItems.forEach(item => {
                const element = document.createElement('a');
                element.href = '#';

                if (item.item_type === 'category') {
                    element.className = 'category-card rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 fade-in';
                    const bgImage = getSubCategoryImage(item.id);
                    element.dataset.bgSrc = bgImage;
                    element.dataset.categoryId = item.id;
                    element.innerHTML = `
                        <div class="category-card-overlay rounded-2xl"></div>
                        <div class="category-card-content">
                            <h3 class="text-xl font-bold">${item.name}</h3>
                        </div>
                    `;
                } else { // item_type === 'service'
                    const service = item;
                    const serviceImage = service.category_img || `https://placehold.co/600x400/ecfdf5/064e3b?text=${encodeURIComponent(service.name)}`;
                    element.className = 'category-card rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 fade-in';
                    element.dataset.bgSrc = serviceImage;
                    element.dataset.serviceId = service.id;

                    let overlayContent = '';
                    if (service.available === false) {
                        element.style.filter = 'grayscale(100%)';
                        element.classList.add('pointer-events-none');
                        overlayContent = `
                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-2xl">
                                <span class="text-white text-lg font-bold">غير متاحة</span>
                            </div>
                        `;
                    }

                    element.innerHTML = `
                        <div class="category-card-overlay rounded-2xl"></div>
                        <div class="category-card-content">
                            <h3 class="text-xl font-bold">${service.name}</h3>
                        </div>
                        ${overlayContent}
                    `;
                }
                subCategoriesContainer.appendChild(element);
                lazyImageObserver.observe(element);
            });

            mainCategoriesSection.classList.add('hidden');
            subCategoriesSection.classList.remove('hidden');
            servicesSection.classList.add('hidden');
            serviceDetailsSection.classList.add('hidden');
        } else {
            // If there are no subcategories, call renderServices to display services in the detailed list view.
            // This preserves the original behavior for service-only categories.
            renderServices(parentId);
        }
    }

    function renderServices(categoryId) {
        currentParentId = categoryId;
        servicesContainer.innerHTML = '';
        const category = gData.categories.find(c => c.id === categoryId);
        servicesTitle.textContent = category?.name || 'الخدمات';
        
        generateBreadcrumb(categoryId, breadcrumbServicesContainer);
        
        const services = gData.services.filter(s => s.category_id === categoryId);

        if (services.length > 0) {
            services.forEach((service, index) => {
                const serviceElement = document.createElement('div');
                let classes = 'bg-white rounded-xl shadow-lg p-4 flex flex-col transition-all duration-300';
                let serviceHTML;

                const price = service.base_price || service.price;
                const serviceImage = service.category_img || `https://placehold.co/600x400/ecfdf5/064e3b?text=${encodeURIComponent(service.name)}`;

                if (service.available === false) {
                    classes += ' relative'; // Needed for overlay positioning
                    serviceElement.style.filter = 'grayscale(100%)';

                    serviceHTML = `
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-xl z-10">
                           <span class="text-white text-lg font-bold">غير متاحة</span>
                        </div>
                        <img loading="lazy" src="${serviceImage}" alt="${service.name}" class="rounded-lg mb-4 w-full h-32 object-cover">
                        <h3 class="text-lg font-bold text-dark-green">${service.name}</h3>
                        <p class="text-sm text-gray-500 my-2">${service.description || ''}</p>
                        <span class="text-xl font-extrabold text-dark-green mt-auto">$${price}</span>
                        <button class="mt-4 w-full py-2 bg-gray-400 text-white font-bold rounded-lg cursor-not-allowed" disabled>اطلب الآن</button>
                    `;
                } else {
                    classes += ' transform hover:scale-105';
                    serviceHTML = `
                        <img loading="lazy" src="${serviceImage}" alt="${service.name}" class="rounded-lg mb-4 w-full h-32 object-cover">
                        <h3 class="text-lg font-bold text-dark-green">${service.name}</h3>
                        <p class="text-sm text-gray-500 my-2">${service.description || ''}</p>
                        <span class="text-xl font-extrabold text-dark-green mt-auto">$${price}</span>
                        <button class="service-details-btn mt-4 w-full py-2 bg-dark-green text-white font-bold rounded-lg hover:bg-green-700 transition-colors duration-300" data-service-id="${service.id}">اطلب الآن</button>
                    `;
                }
                
                serviceElement.className = classes;
                serviceElement.style.animationDelay = `${index * 0.1}s`;
                serviceElement.innerHTML = serviceHTML;

                servicesContainer.appendChild(serviceElement);
                setTimeout(() => serviceElement.classList.add('fade-in'), 10);
            });
        } else {
            servicesContainer.innerHTML = '<p class="text-center col-span-1 md:col-span-2">لا توجد خدمات في هذا التصنيف.</p>';
        }
        mainCategoriesSection.classList.add('hidden');
        subCategoriesSection.classList.add('hidden');
        servicesSection.classList.remove('hidden');
        serviceDetailsSection.classList.add('hidden');
    }

    function renderServiceDetails(serviceId) {
        try {
            const service = gData.services.find(s => s.id == serviceId);
            if (!service) {
                logError(`Service with ID ${serviceId} not found.`, new Error('Service not found.'), true);
                return;
            }
            
            currentService = service;
            
            const basePrice = parseFloat(service.base_price || service.price);
            const serviceImage = service.category_img || `https://placehold.co/600x400/ecfdf5/064e3b?text=${encodeURIComponent(service.name)}`;
            
            generateBreadcrumb(service.category_id, breadcrumbDetailsContainer);
            
            let paramsData = [];
            if (service.params) {
                try {
                    if (typeof service.params === 'string') {
                        const parsedParams = JSON.parse(service.params);
                        if (Array.isArray(parsedParams)) {
                            paramsData = parsedParams;
                        } else {
                            paramsData = service.params.split(',').map(p => p.trim()).filter(p => p.length > 0);
                        }
                    } else if (Array.isArray(service.params)) {
                        paramsData = service.params;
                    }
                } catch (e) {
                    logError("Failed to parse service params. Falling back to string split.", e, false);
                    if (typeof service.params === 'string') {
                        paramsData = service.params.split(',').map(p => p.trim()).filter(p => p.length > 0);
                    }
                }
            }
            
            let serviceDetailsHTML = `
                <div class="flex flex-col items-center">
                    <img loading="lazy" src="${serviceImage}" alt="${service.name}" class="service-details-img mb-4">
                    <h2 class="text-2xl font-bold text-dark-green mb-2">${service.name}</h2>
                    <p class="text-gray-600 mb-4">${service.description || ''}</p>
                `;
            
            if (paramsData && Array.isArray(paramsData) && paramsData.length > 0) {
                serviceDetailsHTML += `<div class="w-full mb-4 space-y-3"><h3 class="text-lg font-semibold text-dark-green">المعلومات المطلوبة:</h3>`;
                paramsData.forEach((param) => {
                    serviceDetailsHTML += `
                        <div>
                            <label for="${param}" class="block text-sm font-medium text-gray-700 mb-1">${param}</label>
                            <input type="${param.includes('كلمة السر') ? 'password' : 'text'}" id="${param}" class="w-full p-2 border border-gray-300 rounded-md" placeholder="أدخل ${param}" required>
                        </div>`;
                });
                serviceDetailsHTML += `</div>`;
            }
            
            let initialQty = 1;
            let qtyValuesType = 'numbers'; // القيمة الافتراضية
            
            if (service.product_type === 'amount') {
                let minQty = 1;
                let maxQty = 5000000;
                try {
                    let qtyValues = service.qty_values;
                    if (typeof qtyValues === 'string') {
                         qtyValues = JSON.parse(qtyValues);
                    }
                    if (qtyValues && typeof qtyValues === 'object' && 'min' in qtyValues && 'max' in qtyValues) {
                        minQty = parseFloat(qtyValues.min);
                        maxQty = parseFloat(qtyValues.max);
                        initialQty = minQty;
                        if (isNaN(minQty) || isNaN(maxQty)) {
                            logError("Invalid min/max values parsed for qty_values. Using defaults.", new Error('NaN values in qty_values.'), false);
                            minQty = 1;
                            maxQty = 5000000;
                        }
                    } else {
                        logError(`Invalid qty_values format for service ${service.id}. Using default values.`, new Error('Invalid JSON format for qty_values.'), false);
                    }
                } catch (e) {
                    logError(`Could not parse qty_values for service ${service.id}. Using default values.`, e, false);
                }
                
                serviceDetailsHTML += `
                    <div class="w-full mb-4">
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">الكمية (${minQty} - ${maxQty})</label>
                        <input type="number" id="quantity" min="${minQty}" max="${maxQty}" value="${initialQty}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>`;
            } else if (service.product_type === 'specificPackage') {
                 try {
                    let qtyValues = service.qty_values;
                    if (typeof qtyValues === 'string') {
                         qtyValues = JSON.parse(qtyValues);
                    }
                    
                    if (Array.isArray(qtyValues) && qtyValues.length > 0) {
                         // تحديد نوع القيم
                         qtyValuesType = determineQtyValuesType(qtyValues);
                         initialQty = qtyValues[0];
                         
                         serviceDetailsHTML += `
                            <div class="w-full mb-4">
                                <label for="quantity-select" class="block text-sm font-medium text-gray-700 mb-2">
                                    ${qtyValuesType === 'numbers' ? 'اختر الكمية' : 'اختر الخيار'}
                                </label>
                                <div id="quantity-options" class="quantity-options">`;
                         qtyValues.forEach((qty) => {
                              serviceDetailsHTML += `
                                <div class="quantity-option cursor-pointer rounded-lg px-4 py-2 bg-gray-200 text-gray-800 hover:bg-dark-green hover:text-white transition duration-200" 
                                     data-qty="${qty}" 
                                     data-type="${qtyValuesType}">
                                    ${qty}
                                </div>`;
                         });
                         serviceDetailsHTML += `</div></div>`;
                    } else {
                        logError(`Invalid qty_values format for service ${service.id}. Expected an array.`, new Error('Invalid JSON array format for qty_values.'), false);
                         serviceDetailsHTML += `<p class="text-red-500 text-center">خطأ في تهيئة الخيارات الثابتة.</p>`;
                    }
                } catch (e) {
                     logError(`Could not parse qty_values for service ${service.id}. Expected a JSON array.`, e, false);
                     serviceDetailsHTML += `<p class="text-red-500 text-center">خطأ في تحميل الخيارات الثابتة.</p>`;
                }
            }

            const initialPrice = basePrice * (qtyValuesType === 'numbers' ? initialQty : 1);

            serviceDetailsHTML += `
                <div class="w-full mb-4 p-3 bg-gray-100 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold">السعر:</span>
                        <span id="total-price" class="text-xl font-bold text-dark-green">$${initialPrice.toFixed(2)}</span>
                    </div>
                </div>
                <button id="confirm-purchase" class="w-full py-3 bg-dark-green text-white font-bold rounded-lg hover:bg-green-700 transition-colors duration-300">تأكيد الطلب</button></div>`;
            
            serviceDetailsContainer.innerHTML = serviceDetailsHTML;
            
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                quantityInput.addEventListener('change', calculateTotalPrice);
                quantityInput.addEventListener('input', calculateTotalPrice);
            }

            const quantityOptions = document.getElementById('quantity-options');
            if (quantityOptions) {
                quantityOptions.querySelectorAll('.quantity-option').forEach((option, index) => {
                    if (index === 0) {
                        option.classList.add('selected');
                    }
                    option.addEventListener('click', (e) => {
                        quantityOptions.querySelectorAll('.quantity-option').forEach(o => o.classList.remove('selected'));
                        e.target.classList.add('selected');
                        calculateTotalPrice();
                    });
                });
            }
            
            document.getElementById('confirm-purchase').addEventListener('click', confirmPurchase);
            
            mainCategoriesSection.classList.add('hidden');
            subCategoriesSection.classList.add('hidden');
            servicesSection.classList.add('hidden');
            serviceDetailsSection.classList.remove('hidden');
        } catch (error) {
            logError('Failed to render service details:', error);
        }
    }

    function calculateTotalPrice() {
        try {
            const totalPriceElement = document.getElementById('total-price');
            if (!totalPriceElement || !currentService) {
                logError('Missing elements for price calculation. Cannot calculate.', new Error('DOM elements missing.'), false);
                return;
            }

            const basePrice = parseFloat(currentService.base_price || currentService.price);
            let quantity;

            if (currentService.product_type === 'specificPackage') {
                const selectedOption = document.querySelector('.quantity-option.selected');
                if (selectedOption) {
                    // الحصول على نوع القيم من السمة data-type
                    const optionType = selectedOption.getAttribute('data-type');
                    const optionValue = selectedOption.getAttribute('data-qty');
                    
                    // إذا كانت القيم أرقامًا، نستخدمها في الحساب
                    if (optionType === 'numbers') {
                        quantity = parseFloat(optionValue);
                    } else {
                        // إذا كانت نصوصًا، نستخدم الكمية 1 (لأن السعر ثابت بغض النظر عن الخيار)
                        quantity = 1;
                    }
                } else {
                    quantity = 1;
                }
            } else if (currentService.product_type === 'amount') {
                const quantityInput = document.getElementById('quantity');
                quantity = parseFloat(quantityInput.value) || 1;
            } else {
                quantity = 1;
            }
            
            if (isNaN(basePrice) || isNaN(quantity)) {
                logError('Invalid price or quantity value. Cannot calculate.', new Error('NaN values detected.'), false);
                totalPriceElement.textContent = `$0.00`;
                return;
            }

            const totalPrice = basePrice * quantity;
            totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
        } catch (error) {
            logError('Error calculating total price:', error, false);
        }
    }

    async function confirmPurchase() {
        if (!currentService) {
            logError('Failed to confirm purchase: currentService is null.', new Error('No service selected.'), true);
            return;
        }

        let paramsToProcess = [];
        if (currentService.params) {
            try {
                if (typeof currentService.params === 'string') {
                    const parsed = JSON.parse(currentService.params);
                    paramsToProcess = Array.isArray(parsed) ? parsed : currentService.params.split(',').map(p => p.trim()).filter(p => p.length > 0);
                } else if (Array.isArray(currentService.params)) {
                    paramsToProcess = currentService.params;
                }
            } catch (e) {
                logError("Failed to parse service params in confirmPurchase. Using fallback.", e, false);
                if (typeof currentService.params === 'string') {
                    paramsToProcess = currentService.params.split(',').map(p => p.trim()).filter(p => p.length > 0);
                }
            }
        }

        const allParamValues = [];
        for (const param of paramsToProcess) {
            const input = document.getElementById(param);
            if (!input || !input.value.trim()) {
                logError(`يرجى ملء حقل: ${param}`, new Error(`Missing required parameter: ${param}`));
                return;
            }
            allParamValues.push(input.value.trim());
        }

        const link_or_id = allParamValues.join(',');

        if (!link_or_id && paramsToProcess.length > 0) {
             logError('يرجى ملء جميع الحقول المطلوبة.', new Error('Missing required parameters.'));
             return;
        }
        
        let quantity;
        let selectedOptionValue = null;
        
        if (currentService.product_type === 'specificPackage') {
            const selectedOption = document.querySelector('.quantity-option.selected');
            if (!selectedOption) {
                logError('Please select an option.', new Error('No option selected.'));
                return;
            }
            
            selectedOptionValue = selectedOption.getAttribute('data-qty');
            const optionType = selectedOption.getAttribute('data-type');
            
            if (optionType === 'numbers') {
                quantity = parseFloat(selectedOptionValue);
            } else {
                quantity = 1;
                // The text option itself is now part of the link_or_id, so no need to send it separately
            }
        } else {
            const quantityInput = document.getElementById('quantity');
            quantity = quantityInput ? parseFloat(quantityInput.value) : 1;
        }
        
        const basePrice = parseFloat(currentService.base_price || currentService.price);
        
        if (isNaN(quantity) || isNaN(basePrice)) {
            logError('Invalid quantity or price value before sending the request.', new Error('NaN quantity or price.'), true);
            return;
        }
        
        let totalPrice = basePrice * quantity;
        
        if (parseFloat(gData.user.balance) < totalPrice) {
            logError('رصيدك غير كافٍ لإتمام هذه العملية. يرجى شحن رصيدك أولاً.', new Error('Insufficient balance.'));
            return;
        }

        try {
            const response = await fetch('/api/create_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    initData: gData.initData,
                    service_id: currentService.id,
                    service_name: currentService.name,
                    quantity: quantity,
                    total_price: totalPrice,
                    link_or_id: link_or_id
                }),
            });

            const result = await response.json();

            if (result.ok) {
                const newBalance = parseFloat(result.new_balance);
                gData.user.balance = newBalance.toFixed(2);
                renderUserInfo();
                showSuccessModal('تم تأكيد طلبك بنجاح! سيتم معالجة طلبك قريباً.');
                renderServices(currentService.category_id);
            } else {
                logError(result.error || 'Failed to create order.', new Error(result.error || 'Failed to create order.'));
            }
        } catch (error) {
            logError('Error creating order:', error);
        }
    }

    function showSuccessModal(message) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold text-dark-green mb-4">نجاح!</h3>
                <p>${message}</p>
                <button onclick="this.closest('.modal').remove()" class="modal-copy-btn mt-4">حسناً</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function showErrorModal(message) {
        document.getElementById('error-log-area').value = logs.map(l => 
            `[${l.timestamp}] ${l.message} - Error: ${l.error}`
        ).join('\n');
        const modalMessageEl = errorModal.querySelector('p');
        modalMessageEl.textContent = message;
        errorModal.classList.remove('hidden');
    }

    closeModalBtn.addEventListener('click', () => {
        errorModal.classList.add('hidden');
    });

    copyLogBtn.addEventListener('click', () => {
        const logArea = document.getElementById('error-log-area');
        logArea.select();
        document.execCommand('copy');
        copyLogBtn.textContent = 'تم النسخ!';
        setTimeout(() => {
            copyLogBtn.textContent = 'نسخ السجل';
        }, 2000);
    });

    mainCategoriesContainer.addEventListener('click', (e) => {
        const categoryCard = e.target.closest('.category-card');
        if (categoryCard) {
            e.preventDefault();
            renderSubCategories(parseInt(categoryCard.dataset.categoryId, 10));
        }
    });

    subCategoriesContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.category-card');
        if (card) {
            e.preventDefault();
            if (card.dataset.categoryId) {
                renderSubCategories(parseInt(card.dataset.categoryId, 10));
            } else if (card.dataset.serviceId) {
                renderServiceDetails(parseInt(card.dataset.serviceId, 10));
            }
        }
    });

    servicesContainer.addEventListener('click', (e) => {
        const serviceDetailsBtn = e.target.closest('.service-details-btn');
        if (serviceDetailsBtn) {
            e.preventDefault();
            renderServiceDetails(parseInt(serviceDetailsBtn.dataset.serviceId, 10));
        }
    });

    backToHomeBtn.addEventListener('click', () => renderMainCategories());

    backToSubcategoriesBtn.addEventListener('click', () => {
         if (currentParentId) {
            const category = gData.categories.find(c => c.id === currentParentId);
            if (category && category.parent_id) {
                renderSubCategories(category.parent_id);
            } else {
                renderMainCategories();
            }
        } else {
            renderMainCategories();
        }
    });

    backToServicesBtn.addEventListener('click', () => {
        if (currentService) {
            renderServices(currentService.category_id);
        } else {
            renderMainCategories();
        }
    });
    </script>
</body>
</html>
